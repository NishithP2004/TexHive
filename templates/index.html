<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overleaf Clone</title>
  <!-- Socket.IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <!-- Monaco Editor Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.js"></script>
  <!-- Configure RequireJS paths for Monaco and Split.js -->
  <script>
    require.config({
      paths: {
        vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs',
        split: 'https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min'
      }
    });
  </script>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ensure the page uses the full viewport with no extra margins */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #1e1e1e;
    }
    /* Header styling */
    header {
      background: #2d2d2d;
    }
    /* The split container occupies all space below the header */
    #split-container {
      display: flex;
      height: calc(100vh - 56px); /* Adjust this value to match your header's height */
    }
    /* Both panes share the same background for a unified look */
    .pane {
      background: #1e1e1e;
      overflow: hidden;
      position: relative;
    }
    /* The PDF viewer (iframe) fills its container and hides borders */
    #pdf-viewer {
      width: 100%;
      height: 100%;
      border: none;
    }
    /* Subtle Split.js gutter styling */
    .gutter {
      background-color: rgba(255, 255, 255, 0.1);
      cursor: col-resize;
      width: 5px;
      z-index: 10;
      transition: background-color 0.2s ease;
    }
    .gutter:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="text-white">
  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3">
    <h1 class="text-2xl font-bold">Overleaf Clone</h1>
    <div class="flex space-x-4">
      <button onclick="compileLatex()" class="px-4 py-2 bg-blue-500 text-white rounded">
        Compile & Preview
      </button>
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="checkbox" id="realtime-toggle" class="hidden" onchange="toggleRealtime()">
        <div class="w-10 h-5 bg-gray-600 rounded-full relative transition-all duration-300">
          <div id="toggle-indicator" class="w-4 h-4 bg-white rounded-full shadow absolute top-0.5 left-0.5 transition-all duration-300"></div>
        </div>
        <span class="text-gray-300">Realtime</span>
      </label>
    </div>
  </header>

  <!-- Split Container for Editor & PDF Viewer -->
  <div id="split-container">
    <!-- Editor Pane -->
    <div id="editor-container" class="pane"></div>
    <!-- PDF Viewer Pane -->
    <div id="pdf-container" class="pane">
      <!-- The #toolbar=0 parameter hides the built-in toolbar in many browsers -->
      <iframe id="pdf-viewer" src="/pdf#toolbar=0"></iframe>
    </div>
  </div>

  <script>
    // Initialize Socket.IO and global variables.
    var socket = io();
    var editor;
    let compileTimeout;
    let realtimeEnabled = false;

    // Load Monaco Editor and register a minimal LaTeX language definition.
    require(['vs/editor/editor.main'], function() {
      // Register our custom 'latex' language.
      monaco.languages.register({ id: 'latex' });
      monaco.languages.setMonarchTokensProvider('latex', {
        tokenizer: {
          root: [
            [/%.*$/, "comment"],
            [/\\[a-zA-Z]+/, "keyword"],
            [/\\./, "keyword"],
            [/\$[^$]*\$/, "string"],
            [/[{}]/, "delimiter"],
          ]
        }
      });

      // Create the editor, disabling the minimap (the preview on the right).
      editor = monaco.editor.create(document.getElementById('editor-container'), {
        value: '\\documentclass{article}\n\\begin{document}\nHello, LaTeX!\n\\end{document}',
        language: 'latex',
        theme: 'vs-dark',
        minimap: { enabled: false },
        automaticLayout: false // We'll call layout() manually on resize.
      });

      // Emit text updates via Socket.IO on changes.
      editor.getModel().onDidChangeContent(() => {
        socket.emit('update_text', { content: editor.getValue() });
        if (realtimeEnabled) {
          clearTimeout(compileTimeout);
          compileTimeout = setTimeout(compileLatex, 1000);
        }
      });
    });

    // Emit a compile event.
    function compileLatex() {
      if (realtimeEnabled || event?.type === 'click') {
        socket.emit('compile_latex');
      }
    }

    // Update the PDF viewer when compilation is done.
    socket.on('compilation_done', function(data) {
      let viewer = document.getElementById('pdf-viewer');
      // Preserve #toolbar=0 while forcing a refresh.
      viewer.src = '/pdf?ts=' + new Date().getTime() + '#toolbar=0';
    });

    // Toggle realtime compilation.
    function toggleRealtime() {
      realtimeEnabled = document.getElementById('realtime-toggle').checked;
      let indicator = document.getElementById('toggle-indicator');
      if (realtimeEnabled) {
        indicator.classList.add('translate-x-5', 'bg-green-500');
        indicator.classList.remove('bg-white');
      } else {
        indicator.classList.remove('translate-x-5', 'bg-green-500');
        indicator.classList.add('bg-white');
      }
    }

    // Initialize Split.js to allow seamless, resizable integration.
    require(['split'], function(Split) {
      Split(['#editor-container', '#pdf-container'], {
        sizes: [50, 50],
        minSize: 300,
        gutterSize: 5,
        // Continuously update the editor layout while dragging.
        onDrag: function() {
          if (editor) {
            editor.layout();
          }
        }
      });
    });
  </script>
</body>
</html>
