<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overleaf Clone</title>
  <!-- Socket.IO -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <!-- Monaco Editor Loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.js"></script>
  <!-- RequireJS configuration for Monaco and Split.js -->
  <script>
    require.config({
      paths: {
        vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs',
        split: 'https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.5/split.min'
      }
    });
  </script>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Additional CSS to style the Split.js gutter -->
  <style>
    .gutter {
      background-color: #444;
      cursor: col-resize;
    }
    .gutter:hover {
      background-color: #555;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <div class="flex flex-col h-screen">
    <!-- Header -->
    <div class="p-4 bg-gray-800 flex justify-between items-center">
      <h1 class="text-2xl font-bold">Overleaf Clone</h1>
      <div class="flex space-x-4">
        <button onclick="compileLatex()" class="px-4 py-2 bg-blue-500 text-white rounded">
          Compile & Preview
        </button>
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="realtime-toggle" class="hidden" onchange="toggleRealtime()" />
          <div class="w-10 h-5 bg-gray-600 rounded-full relative transition-all duration-300">
            <div id="toggle-indicator" class="w-4 h-4 bg-white rounded-full shadow absolute top-0.5 left-0.5 transition-all duration-300"></div>
          </div>
          <span class="text-gray-300">Realtime</span>
        </label>
      </div>
    </div>

    <!-- Split Layout -->
    <div id="split-container" class="flex flex-grow">
      <!-- Editor -->
      <div id="editor-container" class="w-1/2 p-4">
        <h2 class="text-lg mb-2">LaTeX Editor</h2>
        <div id="editor" class="border rounded-lg h-[75vh]"></div>
        <p id="compile-status" class="text-sm text-gray-400 mt-2"></p>
      </div>

      <!-- PDF Preview -->
      <div id="pdf-container" class="w-1/2 p-4">
        <h2 class="text-lg mb-2">PDF Preview</h2>
        <iframe id="pdf-viewer" class="border rounded-lg w-full h-[75vh]"></iframe>
      </div>
    </div>
  </div>

  <script>
    var socket = io();
    var editor;
    let compileTimeout;
    let realtimeEnabled = false;

    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: '\\documentclass{article}\n\\begin{document}\nHello, LaTeX!\n\\end{document}',
        language: 'latex',
        theme: 'vs-dark'
      });

      editor.getModel().onDidChangeContent(() => {
        socket.emit('update_text', { content: editor.getValue() });
        if (realtimeEnabled) {
          clearTimeout(compileTimeout);
          compileTimeout = setTimeout(compileLatex, 1000);
        }
      });

      updateNow();
    });

    function updateNow() {
      socket.emit('update_text', { content: editor.getValue() });
      socket.emit('compile_latex');
    }

    socket.on('update_text', function (data) {
      if (editor.getValue() !== data.content) {
        editor.executeEdits(null, [{
          range: editor.getModel().getFullModelRange(),
          text: data.content
        }]);
      }
    });

    function compileLatex() {
      if (realtimeEnabled || event?.type === 'click') {
        socket.emit('compile_latex');
        document.getElementById('compile-status').textContent = 'Compiling...';
      }
    }

    socket.on('compilation_done', function (data) {
      let viewer = document.getElementById('pdf-viewer');
      viewer.src = '/pdf?ts=' + new Date().getTime();
      document.getElementById('compile-status').textContent = 'Compiled Successfully';
    });

    function toggleRealtime() {
      realtimeEnabled = document.getElementById('realtime-toggle').checked;
      let indicator = document.getElementById('toggle-indicator');
      if (realtimeEnabled) {
        indicator.classList.add('translate-x-5', 'bg-green-500');
        indicator.classList.remove('bg-white');
        updateNow();
      } else {
        indicator.classList.remove('translate-x-5', 'bg-green-500');
        indicator.classList.add('bg-white');
      }
    }

    require(['split'], function (Split) {
      Split(['#editor-container', '#pdf-container'], {
        sizes: [50, 50],
        minSize: 300,
        gutterSize: 10,
        onDrag: function() {
          if (editor) {
            editor.layout();
          }
        }
      });
    });
  </script>
</body>
</html>
